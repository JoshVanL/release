# When a cert-manager/release PR is merged, this workflow generates prow
# testing config for a set of cert-manager branches, and if out-of-sync with
# jetstack/testing master, will create a new PR with those changes.
#
# We use the https://github.com/peter-evans/create-pull-request action to
# create a pull request if it is needed.

name: Update jetstack/testing with cert-manager/cert-manager prow test config.
on:
  push:
    branches:
      - test-prow
jobs:
  update-prow-config:
    runs-on: ubuntu-22.04
    steps:
    - name: install_go
      uses: actions/setup-go@v3
      with:
        go-version: 1.19

    - name: checkout cert-manager/release
      uses: actions/checkout@v3

    - name: build cmrel
      run: |
        go install ./cmd/cmrel

    - name: checkout jetstack/testing
      uses: actions/checkout@v3
      with:
        repository: jetstack/testing

    - name: generate prow config.
      run: |
        cd config/jobs/cert-manager/cert-manager
        # Preserve hand-rolled bazel tests and READMEs
        find . ! \( -name '*bazel*' -o -name '*.md' \) -type f -exec rm -rf {} +
        # Delete empty directories
        find . -empty -type d -delete
        cmrel generate-prow  --branch '*' -o file

    - name: create pull request if there are changes
      uses: peter-evans/create-pull-request@v4
      id: cpr
      with:
        delete-branch: true
        signoff: true
        title: "Update cert-manager/cert-manager prow config"
        branch: "update-cert-manager-prow-config"

    - name: check outputs
      if: ${{ steps.cpr.outputs.pull-request-number }}
      run: |
        echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
        echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"
